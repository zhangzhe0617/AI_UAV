<!DOCTYPE html>
<!-- saved from url=(0095)https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html -->
<html lang="zh-CN" class="translated-ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>使用非常少的数据构建强大的图像分类模型</title>
        
        <link rel="stylesheet" href="./使用非常少的数据构建强大的图像分类模型_files/main.css" type="text/css">
        <link rel="stylesheet" href="./使用非常少的数据构建强大的图像分类模型_files/pygment.css" type="text/css">

        <link href="./使用非常少的数据构建强大的图像分类模型_files/css" rel="stylesheet" type="text/css">
        <link href="https://blog.keras.io/" type="application/atom+xml" rel="alternate" title="Keras Blog ATOM Feed">


        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="//blog.keras.io/css/ie.css"/>
                <script src="//blog.keras.io/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="//blog.keras.io/css/ie6.css"/><![endif]-->

<link type="text/css" rel="stylesheet" charset="UTF-8" href="./使用非常少的数据构建强大的图像分类模型_files/translateelement.css"></head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1>
                    <a href="https://blog.keras.io/index.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keras博客 </font></font></a>
                </h1>
                <p id="side">
                    <a href="https://github.com/fchollet/keras"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Keras</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是Python的深度学习库，它简单，模块化，可扩展。
                </font></font></p>
                <nav><ul>
                <li><a href="https://blog.keras.io/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">档案</font></font></a></li>
                    <li>
                        <a href="https://github.com/fchollet/keras"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github上</font></font></a>
                    </li>
                    <li>
                        <a href="http://keras.io/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档</font></font></a>
                    </li>
                    <li>
                        <a href="https://groups.google.com/forum/#!forum/keras-users"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">谷歌集团</font></font></a>
                    </li>
                </ul></nav>
        </header><!-- /#banner -->

<section id="content" class="body">
<article>
        <header> <h1 class="entry-title"><a href="https://blog.keras.io/building-powerful-image-classification-models-using-very-little-data.html" rel="bookmark" title="使用非常少的数据构建强大的图像分类模型的永久链接"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用非常少的数据构建强大的图像分类模型</font></font></a></h1>  </header>
        <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-06-05T00：00：00 + 02：00"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                2016年6月5日星期日
        </font></font></abbr>

        <address class="vcard author"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                作者：</font></font><a class="url fn" href="https://twitter.com/fchollet"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Francois Chollet</font></font></a>
        </address>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><a href="https://blog.keras.io/category/tutorials.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">教程中</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>
<p></p></footer><!-- /.post-info --><!-- /.post-info -->
        <p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在本教程中，我们将介绍一些简单而有效的方法，您可以使用这些方法构建一个功能强大的图像分类器，只使用很少的训练示例 - 只需要您想要识别的每个类中的几百或几千张图片。 </font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将介绍以下选项：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从头开始训练小型网络（作为基线）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用预先训练的网络的瓶颈功能</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">微调预训练网络的顶层</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这将引导我们涵盖以下Keras功能：</font></font></p>
<ul>
<li><code>fit_generator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 用于训练Keras使用Python数据生成器的模型</font></font></li>
<li><code>ImageDataGenerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 用于实时数据增强</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">层冻结和模型微调</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">...和更多。</font></font></li>
</ul>
<p><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：所有代码示例已于2017年3月14日更新为Keras 2.0 API。您需要Keras 2.0.0或更高版本才能运行它们。</font></font></strong></p>
<hr>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们的设置：仅2000个培训示例（每班1000个）</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将从以下设置开始：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">安装了Keras，SciPy，PIL的机器。</font><font style="vertical-align: inherit;">如果你有一个可以使用的NVIDIA GPU（并且安装了cuDNN），那很好，但是因为我们正在使用一些并非绝对必要的图像。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">训练数据目录和验证数据目录，每个图像类包含一个子目录，填充.png或.jpg图像：</font></font></li>
</ul>
<div class="highlight"><pre><span></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据/</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    培养/</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        小狗/</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            dog001.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            dog002.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        猫/</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            cat001.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            cat002.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
    验证/</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        小狗/</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            dog001.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            dog002.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            ...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
        猫/</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            cat001.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            cat002.jpg</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
            ...</font></font><font></font>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要获得属于您感兴趣的类的数百或数千个训练图像，一种可能性是使用</font></font><a href="https://www.flickr.com/services/api/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flickr API</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在友好许可下下载与给定标记匹配的图片。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在我们的例子中，我们将使用两组图片，我们</font></font><a href="https://www.kaggle.com/c/dogs-vs-cats/data"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从Kaggle获得</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：1000只猫和1000只狗（尽管原始数据集有12,500只猫和12,500只狗，我们只为每个类拍摄了前1000张图像）。</font><font style="vertical-align: inherit;">我们还使用每个类别的400个额外样本作为验证数据，以评估我们的模型。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于一个远非简单的分类问题，这是很少要学习的例子。</font><font style="vertical-align: inherit;">因此，这是一个具有挑战性的机器学习问题，但它也是一个现实的问题：在许多现实世界的使用案例中，即使是小规模的数据收集也可能非常昂贵或有时几乎不可能（例如在医学成像中）。</font><font style="vertical-align: inherit;">能够充分利用非常少的数据是有能力的数据科学家的关键技能。</font></font></p>
<p><img alt="猫和狗" src="./使用非常少的数据构建强大的图像分类模型_files/cats_and_dogs.png"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这个问题有多难？</font><font style="vertical-align: inherit;">当Kaggle开始参加猫与狗比赛（共计25,000张训练图像）时，两年多前，它有以下声明：</font></font></p>
<p><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“在多年前进行的非正式民意调查中，计算机视觉专家认为，如果没有现有技术的重大进步，精度高于60％的分类器将很难。作为参考，60％的分类器提高了猜测的概率。从1/4096到1/459的12幅图像HIP。目前的文献表明，机器分类器在此任务上的准确度可以达到80％以上</font></font><a href="http://xenon.stanford.edu/~pgolle/papers/dogcat.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[参考]</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。“</font></font></em></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在最终的比赛中，顶级参赛者通过使用现代深度学习技术获得了超过98％的准确率。</font><font style="vertical-align: inherit;">在我们的例子中，因为我们仅将自己限制在数据集的8％，所以问题要困难得多。</font></font></p>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">论深度学习对小数据问题的相关性</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我经常听到的一条信息是“深度学习只有在你拥有大量数据时才有意义”。</font><font style="vertical-align: inherit;">虽然不完全不正确，但这有点误导。</font><font style="vertical-align: inherit;">当然，深度学习需要能够从数据中自动学习特征，这通常只有在有大量训练数据可用时才有可能 - 特别是对于输入样本非常高维的问题，如图像。</font><font style="vertical-align: inherit;">然而，卷积神经网络 - 深度学习的支柱算法 - 是设计用于大多数“感知”问题（例如图像分类）的最佳模型之一，即使只有很少的数据需要学习。</font><font style="vertical-align: inherit;">在小图像数据集上从头开始训练一个小天网仍然会产生合理的结果，而不需要任何自定义特征工程。</font><font style="vertical-align: inherit;">Convnets只是简单的好。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但更重要的是，深度学习模型本质上是高度可再利用的：例如，您可以采用在大规模数据集上训练的图像分类或语音到文本模型，然后在一个显着不同的问题上重复使用它，只需进行微小的更改，如我们将在这篇文章中看到。</font><font style="vertical-align: inherit;">特别是在计算机视觉的情况下，许多预先训练的模型（通常在ImageNet数据集上训练）现在可以公开下载，并且可以用于从非常少的数据中引导强大的视觉模型。</font></font></p>
<hr>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据预处理和数据增强</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了充分利用我们的一些训练样例，我们将通过一系列随机变换来“扩充”它们，这样我们的模型就不会看到完全相同的两次图像。</font><font style="vertical-align: inherit;">这有助于防止过度拟合，并有助于模型更好地概括。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Keras，这可以通过</font></font><code>keras.preprocessing.image.ImageDataGenerator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">课程</font><font style="vertical-align: inherit;">来完成</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">该课程允许您：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">配置在训练期间对图像数据执行的随机变换和标准化操作</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过</font></font><code>.flow(data, labels)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font><font style="vertical-align: inherit;">实例化增强图像批次（及其标签）的生成器</font></font><code>.flow_from_directory(directory)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这些发电机然后可以与接受数据生成作为输入，Keras模型方法中使用</font></font><code>fit_generator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><code>evaluate_generator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><code>predict_generator</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们马上看一个例子：</font></font></p>
<div class="highlight"><pre><span></span><span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自</font></font></span> <span class="nn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keras.preprocessing.image </font></font></span> <span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">导入</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datagen </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rotation_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">width_shift_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">height_shift_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新缩放</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shear_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zoom_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">horizo​​ntal_flip </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">真</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fill_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'最近' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这些只是一些可用选项（更多信息，请参阅</font></font><a href="http://keras.io/preprocessing/image/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">文档</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">让我们快速回顾一下我们刚写的内容：</font></font></p>
<ul>
<li><code>rotation_range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 是一个度数（0-180）的值，是一个随机旋转图片的范围</font></font></li>
<li><code>width_shift</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且</font></font><code>height_shift</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是在垂直或水平方向上随机平移图片的范围（作为总宽度或高度的一部分）</font></font></li>
<li><code>rescale</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个值，我们将在任何其他处理之前将数据相乘。</font><font style="vertical-align: inherit;">我们的原始图像包含0-255中的RGB系数，但是这些值对于我们的模型来说太高了（给定典型的学习速率），所以我们将目标值设置在0和1之间，而不是用1/255进行缩放。</font><font style="vertical-align: inherit;">因子。</font></font></li>
<li><code>shear_range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">用于随机应用</font></font><a href="https://en.wikipedia.org/wiki/Shear_mapping"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">剪切变换</font></font></a></li>
<li><code>zoom_range</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 用于随机缩放图片内部</font></font></li>
<li><code>horizontal_flip</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 用于水平地随机翻转一半图像 - 当没有水平不对称假设时（例如真实世界的图片）是相关的。</font></font></li>
<li><code>fill_mode</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 是用于填充新创建的像素的策略，可以在旋转或宽度/高度偏移后出现。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在让我们开始使用这个工具生成一些图片并将它们保存到临时目录中，这样我们就可以了解我们的增强策略正在做什么 - 我们在这种情况下禁用重新缩放以保持图像可显示：</font></font></p>
<div class="highlight"><pre><span></span><span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">来自</font></font></span> <span class="nn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keras.preprocessing.image </font></font></span> <span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">导入</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">array_to_img </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img_to_array </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load_img</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datagen </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rotation_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">40 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">width_shift_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">height_shift_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shear_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zoom_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">horizo​​ntal_flip </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">True </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fill_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'nearest' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load_img </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'data / train / cats / cat.0.jpg' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是PIL图像</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img_to_array </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是一个形状为（</font></font></span>
<font style="vertical-align: inherit;"><span class="n"><font style="vertical-align: inherit;">3,150,150 </font></span><span class="c1"><font style="vertical-align: inherit;">）</font></span></font><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><font style="vertical-align: inherit;"><span class="c1"><font style="vertical-align: inherit;">的Numpy数组</font></span></font><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重塑</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，）</font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形状</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是一个形状为Numpy的数组（1,3,150,150）</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃下面的流式细胞（）命令产生的随机变换图像的批次</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃和结果保存到`预览/目录</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我</font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span>
<span class="k"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对于</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">批次</font></font></span> <span class="ow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datagen </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">x </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
                          <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save_to_dir </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'preview' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save_prefix </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'cat' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save_format </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'jpeg' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）：</font></font></span>
    <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ = </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span>
    <span class="k"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">i </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&gt; </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">20 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font></span>
        <span class="k"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">break </font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃否则生成器将无限循环</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这就是我们得到的 - 这就是我们的数据增强策略的样子。</font></font></p>
<p><img alt="猫数据增加" src="./使用非常少的数据构建强大的图像分类模型_files/cat_data_augmentation.png"></p>
<hr>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从头开始训练一个小小的网站：40行代码的准确率达到80％</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图像分类工作的正确工具是一个回转网络，所以让我们尝试在我们的数据上训练一个作为初始基线。</font><font style="vertical-align: inherit;">由于我们只有很少的例子，我们的头号问题应该是</font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">过度拟合</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">当暴露于太少示例的模型学习不能推广到新数据的模式时，即当模型开始使用不相关的特征进行预测时，就会发生过度拟合。</font><font style="vertical-align: inherit;">例如，如果你作为一个人，只能看到三个伐木工人的图像，三个是水手人的图像，其中只有一个伐木工人戴着帽子，你可能会开始认为戴帽子是一个作为一名伐木工人的标志，而不是一名水手。</font><font style="vertical-align: inherit;">然后你会做一个非常糟糕的伐木工/水手分类器。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数据增加是对抗过度拟合的一种方法，但这还不够，因为我们的增强样本仍然是高度相关的。</font><font style="vertical-align: inherit;">您过度拟合的主要焦点应该是模型的熵能力 - 您的模型可以存储多少信息。</font><font style="vertical-align: inherit;">通过利用更多功能，可以存储大量信息的模型可能更加准确，但开始存储不相关的功能也存在风险。</font><font style="vertical-align: inherit;">同时，只能存储一些功能的模型必须关注数据中发现的最重要的功能，这些功能更有可能真正相关并更好地推广。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调制熵容量有不同的方法。</font><font style="vertical-align: inherit;">主要的是选择模型中的参数数量，即层数和每层的大小。</font><font style="vertical-align: inherit;">另一种方法是使用权重正则化，例如L1或L2正则化，其包括迫使模型权重接受较小的值。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在我们的例子中，我们将使用一个非常小的convnet，每层有少量层和少量过滤器，以及数据增加和丢失。</font><font style="vertical-align: inherit;">Dropout还有助于减少过度拟合，防止图层看到完全相同模式的两倍，从而以类似于数据增强的方式运行（您可以说丢失和数据增加都会破坏数据中出现的随机关联）。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">下面的代码片段是我们的第一个模型，一个包含3个卷积层的简单堆栈，其中包含ReLU激活，然后是最大池化层。</font><font style="vertical-align: inherit;">这与Yann LeCun在20世纪90年代提倡的用于图像分类的架构（ReLU除外）非常相似。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以在</font></font><a href="https://gist.github.com/fchollet/0830affa1f7f19fd47b06d4cf89ed44d"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到此实验的完整代码</font><font style="vertical-align: inherit;">。</font></font></p>
<div class="highlight"><pre><span></span><span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从</font></font></span> <span class="nn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keras.models </font></font></span> <span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">导入</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顺序</font></font></span>
<span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从</font></font></span> <span class="nn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keras.layers </font></font></span> <span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">进口</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conv2D </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MaxPooling2D </font></font></span>
<span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从</font></font></span> <span class="nn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keras.layers </font></font></span> <span class="kn"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">导入</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">激活</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">差</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">压扁</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">model </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（）</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conv2D </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">32 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_shape </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">激活</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'relu' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MaxPooling2D </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pool_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）））</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conv2D </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">32 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">激活</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'relu' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MaxPooling2D </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pool_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）））</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conv2D </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">激活</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'relu' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MaxPooling2D </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pool_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）））</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃到目前为止的模型输出3D特征图（高度，宽度，特征）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在它的顶部，我们粘贴两个完全连接的层。</font><font style="vertical-align: inherit;">我们用一个单元和一个sigmoid激活结束模型，这对于二进制分类是完美的。</font><font style="vertical-align: inherit;">为此，我们还将使用</font></font><code>binary_crossentropy</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">损失来训练我们的模型。</font></font></p>
<div class="highlight"><pre><span></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flatten </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（））</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃this将我们的3D特征映射转换为1D特征向量</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密集</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">激活</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'relu' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dropout </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.5 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密集</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">激活</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'sigmoid' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编译</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loss </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'binary_crossentropy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
              <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimizer </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'rmsprop' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
              <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metrics </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'accuracy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">]）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们准备我们的数据。</font><font style="vertical-align: inherit;">我们将</font></font><code>.flow_from_directory()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">直接从各自文件夹中的jpgs生成批量图像数据（及其标签）。</font></font></p>
<div class="highlight"><pre><span></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是我们将用于训练的增强结构</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_datagen </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新缩放</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shear_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zoom_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">horizo​​ntal_flip </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">真</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是我们将用于测试的增强结构：</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃只重新缩放</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test_datagen </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新缩放</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是一个生成器，它将读取</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'data / train'的#subfolers中</font></font></span>
<font style="vertical-align: inherit;"><span class="c1"><font style="vertical-align: inherit;">找到的图片</font></span><span class="c1"><font style="vertical-align: inherit;">，并无限期地生成</font></span></font><span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃批量的增强图像数据</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_generator </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_datagen </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow_from_directory </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'数据/火车' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是目标目录</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">target_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）， </font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃</font><font style="vertical-align: inherit;">所有图像将被调整为150×150 </font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'二进制' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为我们使用binary_crossentropy损失＃，我们需要二进制标签</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃这是一个类似的生成器，用于验证数据</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_generator </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test_datagen </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow_from_directory </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'数据/确认' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">target_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'二进制' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们现在可以使用这些发电机来训练我们的模型。</font><font style="vertical-align: inherit;">每个纪元在GPU上需要20-30秒，在CPU上需要300-400秒。</font><font style="vertical-align: inherit;">因此，如果您不赶时间，在CPU上运行此模型绝对可行。</font></font></p>
<div class="highlight"><pre><span></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fit_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">steps_per_epoch </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2000 </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历元</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_data </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_steps </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">800 </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save_weights </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'first_try.h5' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃总是在训练后或训练期间保存你的体重</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这种方法使我们在50个时期之后达到0.79-0.81的验证准确度（这个数字是任意选择的 - 因为模型很小并且使用了咄咄逼人的辍学，到那时它似乎不会过度拟合）。</font><font style="vertical-align: inherit;">因此，在推出Kaggle比赛时，我们已经成为“最先进的” - 拥有8％的数据，并且没有努力优化我们的架构或超参数。</font><font style="vertical-align: inherit;">事实上，在Kaggle比赛中，这个模型将进入前100名（215名参赛者中）。</font><font style="vertical-align: inherit;">我想至少有115名参赛者没有使用深度学习;）</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">请注意，验证准确度的方差相当高，因为准确度是一个高方差度量，因为我们只使用800个验证样本。</font><font style="vertical-align: inherit;">在这种情况下，一个很好的验证策略是进行k折交叉验证，但这需要在每轮评估中训练k模型。</font></font></p>
<hr>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用预先训练的网络的瓶颈功能：一分钟内准确率达到90％</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更精确的方法是利用在大型数据集上预先训练的网络。</font><font style="vertical-align: inherit;">这样的网络已经学习了对大多数计算机视觉问题有用的特征，并且利用这些特征将使我们能够比仅依赖于可用数据的任何方法获得更好的准确性。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将使用VGG16架构，该架构在ImageNet数据集上进行了预训练 - 这是此博客之前的模型。</font><font style="vertical-align: inherit;">由于ImageNet数据集在其总共1000个类中包含多个“猫”类（波斯猫，暹罗猫......）和许多“狗”类，因此该模型已经学习了与我们的分类问题相关的特征。</font><font style="vertical-align: inherit;">实际上，仅仅记录模型的softmax预测而不是瓶颈特征就足以解决我们的狗与猫的分类问题。</font><font style="vertical-align: inherit;">然而，我们在这里提出的方法更有可能很好地推广到更广泛的问题，包括ImageNet中缺少类的问题。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这就是VGG16架构的样子：</font></font></p>
<p><img src="./使用非常少的数据构建强大的图像分类模型_files/vgg16_original.png" alt="vgg16" style="width: 400px;"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们的策略如下：我们只会实例化模型的卷积部分，直到完全连接的层。</font><font style="vertical-align: inherit;">然后，我们将在训练和验证数据上运行此模型一次，在两个numpy阵列中记录输出（来自VGG16模型的“瓶颈特征”：完全连接的层之前的最后一个激活映射）。</font><font style="vertical-align: inherit;">然后，我们将在存储的功能之上训练一个小的完全连接模型。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们之所以离线存储这些功能而不是直接在冻结的卷积基础上添加我们的完全连接模型并运行整个功能，是因为计算效率。</font><font style="vertical-align: inherit;">运行VGG16很昂贵，特别是如果你正在使用CPU，我们只想做一次。</font><font style="vertical-align: inherit;">请注意，这会阻止我们使用数据扩充。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以在</font></font><a href="https://gist.github.com/fchollet/f35fbc80e066a49d65f1688a7e99f069"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到此实验的完整代码</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">你可以</font></font><a href="https://gist.github.com/baraldilorenzo/07d7802847aaad0a35d3"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获得权重文件</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们不会检查模型的构建和加载方式 - 这已经在多个Keras示例中介绍过了。</font><font style="vertical-align: inherit;">但是让我们来看看如何使用图像数据生成器记录瓶颈特征：</font></font></p>
<div class="highlight"><pre><span></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generator </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datagen </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow_from_directory </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'数据/火车' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">target_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃。这意味着我们的发生器将仅数据的产量批次，没有标签</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">洗牌</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>  <span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃我们的数据将在顺序，因此，所有前1000个图像都是猫，然后是1000只狗</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">#sina_generator方法返回模型的输出，给定#a </font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">生成批量的numpy数据的生成器</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">瓶颈</font></font></span> <font style="vertical-align: inherit;"><span class="c1"><font style="vertical-align: inherit;">_features_train </font></span></font><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">=</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">predict_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2000 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃将输出保存为Numpy数组</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">np </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="nb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'bottleneck_features_train.npy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'w' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bottleneck_features_train </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generator </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">datagen </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow_from_directory </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'数据/确认' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">target_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">150 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">洗牌</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bottleneck_features_validation </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">predict_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">800 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">np </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保存</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="nb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">打开</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'bottleneck_features_validation.npy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'w'</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bottleneck_features_validation </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后我们可以加载我们保存的数据并训练一个小的完全连接的模型：</font></font></p>
<div class="highlight"><pre><span></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_data </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">np </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="nb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'bottleneck_features_train.npy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃功能按顺序保存，因此重新创建标签很方便</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_labels </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">np </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（[ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000 </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ </font></font></span> <span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1000 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_data </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">np </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="nb"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">open </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'bottleneck_features_validation.npy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_labels </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">np </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（[ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">400 </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">+ </font></font></span> <span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">] </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">* </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">400 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">model </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（）</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（展</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_shape </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_data </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">形状</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：]））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密集</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">256 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">激活</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'relu' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dropout </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.5 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dense </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activation </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'sigmoid' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">compile </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">optimizer </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'rmsprop' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
              <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loss </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'binary_crossentropy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
              <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">metrics </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'accuracy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">]）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">适合</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_data </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_labels </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
          <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历元</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">50 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
          <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
          <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_data </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_data </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_labels </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">save_weights </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'bottleneck_fc_model.h5' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于它的体积小，这种型号甚至可以在CPU（每个时期1秒）上快速训练：</font></font></p>
<div class="highlight"><pre><span></span><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">训练2000个样本，验证800个样本</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大纪元1/50</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2000/2000 [==============================]  -  1s  - 损失：0.8932  -  acc：0.7345  -  val_loss：0.2664  - val_acc：0.8862</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大纪元2/50</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2000/2000 [==============================]  -  1s  - 损失：0.3556  -  acc：0.8460  -  val_loss：0.4704  - val_acc：0.7725</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
...</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大纪元47/50</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2000/2000 [==============================]  -  1s  - 损失：0.0063  -  acc：0.9990  -  val_loss：0.8230  - val_acc：0.9125</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大纪元48/50</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2000/2000 [==============================]  -  1s  - 损失：0.0144  -  acc：0.9960  -  val_loss：0.8204  - val_acc：0.9075</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大纪元49/50</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2000/2000 [==============================]  -  1s  - 损失：0.0102  -  acc：0.9960  -  val_loss：0.8334  - val_acc：0.9038</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
大纪元50/50</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2000/2000 [==============================]  -  1s  - 损失：0.0040  -  acc：0.9985  -  val_loss：0.8556  - val_acc：0.9075</font></font><font></font>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们达到0.90-0.91的验证准确度：一点也不差。</font><font style="vertical-align: inherit;">这在一定程度上部分原因在于基础模型是在已经具有狗和猫（其他数百个类别）的数据集上进行训练的。</font></font></p>
<hr>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">微调预训练网络的顶层</font></font></h2>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了进一步改进我们之前的结果，我们可以尝试与顶级分类器一起“微调”VGG16模型的最后一个卷积块。</font><font style="vertical-align: inherit;">微调包括从训练有素的网络开始，然后使用非常小的权重更新在新数据集上重新训练它。</font><font style="vertical-align: inherit;">在我们的例子中，这可以分3个步骤完成：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实例化VGG16的卷积基数并加载其权重</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在顶部添加我们先前定义的完全连接模型，并加载其权重</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">冻结VGG16模型的层到最后一个卷积块</font></font></li>
</ul>
<p><img src="./使用非常少的数据构建强大的图像分类模型_files/vgg16_modified.png" alt="vgg16：微调" style="width: 400px;"></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">注意：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了进行微调，所有层都应该从训练有素的权重开始：例如，你不应该在预先训练好的卷积基础上打一个随机初始化的全连接网络。</font><font style="vertical-align: inherit;">这是因为由随机初始化的权重触发的大梯度更新将破坏卷积基础中的学习权重。</font><font style="vertical-align: inherit;">在我们的例子中，这就是为什么我们首先训练顶级分类器，然后才开始微调卷积权重。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们选择仅微调最后的卷积块而不是整个网络以防止过度拟合，因为整个网络将具有非常大的熵容量并因此具有过度拟合的强烈倾向。</font><font style="vertical-align: inherit;">低级卷积块学习的特征比较高级的卷积块更加通用，不那么抽象，所以保持前几个块固定（更一般的特征）并且只调整最后一个块（更专业的特征）是明智的。 ）。</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">微调应该以非常慢的学习速率完成，通常使用SGD优化器而不是适应性学习速率优化器，例如RMSProp。</font><font style="vertical-align: inherit;">这是为了确保更新的幅度保持非常小，以免破坏以前学过的功能。</font></font></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您可以在</font></font><a href="https://gist.github.com/fchollet/7eb39b44eb9e16e59632d25fb3119975"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">找到此实验的完整代码</font><font style="vertical-align: inherit;">。</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在实例化VGG基础并加载其权重后，我们在顶部添加了之前训练有素的完全连接分类器：</font></font></p>
<div class="highlight"><pre><span></span><span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃构建一个分类器模型，放在卷积模型</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sequential </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（）</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model之上</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">平铺</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">input_shape </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">output_shape </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：]））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dense </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">256 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activation </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'relu' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">add </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dropout </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.5 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">密集</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">activation </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'sigmoid' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">））</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃请注意，有必要从经过全面训练的</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃分类器开始，包括顶级分类器</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃，以便成功地对</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model </font></font></span><font style="vertical-align: inherit;"><span class="c1"><font style="vertical-align: inherit;">进行微调</font></span></font><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">load_weights </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model_weights_path </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃在卷积基础</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型的</font></font></span><font style="vertical-align: inherit;"><span class="c1"><font style="vertical-align: inherit;">顶部添加</font></span><span class="n"><font style="vertical-align: inherit;">模型</font></span></font><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top_model </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后我们继续将所有卷积层冻结到最后一个卷积块：</font></font></p>
<div class="highlight"><pre><span></span><span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃设定第一层25（直到最后一个块CONV） </font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃</font><font style="vertical-align: inherit;">到非可训练（权重将不被更新）</font></font></span>
<span class="k"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">层</font></font></span> <span class="ow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">layers </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[：</font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">25 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">]：</font></font></span>
    <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">图层</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">trainable </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃使用SGD /动量优化器编译模型</font></font></span>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃并且学习速度非常慢。</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模特</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编译</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">损耗</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'binary_crossentropy' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
              <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">优化</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SGD </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LR </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1E-4 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">动量</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.9 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span>
              <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">度量</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'准确性' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">]）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后，我们开始训练整个事情，学习速度非常慢：</font></font></p>
<div class="highlight"><pre><span></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">16</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃准备数据扩张配置</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_datagen </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新缩放</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shear_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zoom_range </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0.2 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">horizo​​ntal_flip </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="bp"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">真</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test_datagen </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImageDataGenerator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重新缩放</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="mf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1 </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ </font></font></span><span class="mi"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255 </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_generator </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_datagen </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow_from_directory </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_data_dir </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">target_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img_height </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img_width </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'binary' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_generator </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">test_datagen </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flow_from_directory </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_data_dir </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">target_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img_height </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">img_width </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">class_mode </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="s1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">'binary' </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span><font></font>
<font></font>
<span class="c1"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">＃微调模型</font></font></span>
<span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">模型</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fit_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">train_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">steps_per_epoch </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nb_train_samples </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">历元</font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时期</font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_data </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_generator </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></span>
        <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">validation_steps </font></font></span><span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= </font></font></span><span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nb_validation_samples </font></font></span> <span class="o"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">// </font></font></span> <span class="n"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的batch_size </font></font></span><span class="p"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）</font></font></span>
</pre></div>


<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这种方法使我们在50个时期之后达到0.94的验证准确度。</font><font style="vertical-align: inherit;">巨大的成功！</font></font></p>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下是一些您可以尝试达到0.95以上的方法：</font></font></p>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更具侵略性的数据扩充</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更积极的辍学</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用L1和L2正则化（也称为“重量衰减”）</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">微调一个卷积块（同时更大的正则化）</font></font></li>
</ul>
<hr>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这篇文章在这里结束！</font><font style="vertical-align: inherit;">回顾一下，在这里您可以找到我们三个实验的代码：</font></font></p>
<ul>
<li><a href="https://gist.github.com/fchollet/0830affa1f7f19fd47b06d4cf89ed44d"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convnet从头开始训练</font></font></a></li>
<li><a href="https://gist.github.com/fchollet/f35fbc80e066a49d65f1688a7e99f069"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">瓶颈功能</font></font></a></li>
<li><a href="https://gist.github.com/fchollet/7eb39b44eb9e16e59632d25fb3119975"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">微调</font></font></a></li>
</ul>
<p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您对此帖子有任何评论或有关未来主题的任何建议，您可以</font></font><a href="https://twitter.com/fchollet"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在Twitter上联系</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></p>
<hr>
        </div><!-- /.entry-content -->

</article>
</section>

        <footer id="footer" class="body">
                <address id="about" class="vcard body"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
                由</font></font><a href="http://alexis.notmyidea.org/pelican/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">鹈鹕驱动</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，它具有</font></font><a href="http://python.org/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">python的</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">巨大优势</font><font style="vertical-align: inherit;">。
                </font></font></address><!-- /#about -->
        </footer><!-- /#footer -->

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script src="./使用非常少的数据构建强大的图像分类模型_files/ga.js.下载" type="text/javascript"></script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-61785484-1");
    pageTracker._trackPageview();
    } catch(err) {}</script><div id="goog-gt-tt" class="skiptranslate" dir="ltr"><div style="padding: 8px;"><div><div class="logo"><img src="./使用非常少的数据构建强大的图像分类模型_files/translate_24dp.png" width="20" height="20" alt="Google 翻译"></div></div></div><div class="top" style="padding: 8px; float: left; width: 100%;"><h1 class="title gray">原文</h1></div><div class="middle" style="padding: 8px;"><div class="original-text"></div></div><div class="bottom" style="padding: 8px;"><div class="activity-links"><span class="activity-link">提供更好的翻译建议</span><span class="activity-link"></span></div><div class="started-activity-container"><hr style="color: #CCC; background-color: #CCC; height: 1px; border: none;"><div class="activity-root"></div></div></div><div class="status-message" style="display: none;"></div></div>

<div class="goog-te-spinner-pos"><div class="goog-te-spinner-animation"><svg xmlns="http://www.w3.org/2000/svg" class="goog-te-spinner" width="96px" height="96px" viewBox="0 0 66 66"><circle class="goog-te-spinner-path" fill="none" stroke-width="6" stroke-linecap="round" cx="33" cy="33" r="30"></circle></svg></div></div></body></html>